dataSource:
  name: Impressions
  rootPath: /Users/sven.zhang/Documents/local_test
  prefix: /source=impressions/raw/year={year}/month={monthMM}/day={dayDD}/hourPart={hourInt}/
  format: parquet
  loadQuery: |
    SELECT
      UIID as TDID,
      CampaignId,
      AdvertiserId,
      CONCAT(CAST(AdWidthInPixels AS STRING), 'x', CAST(AdHeightInPixels AS STRING)) AS AdFormat,
      CASE
        WHEN UIID IS NOT NULL AND UIID != '00000000-0000-0000-0000-000000000000' THEN 1
        ELSE 0
      END AS IsTracked,
      Site,
      HOUR(LogEntryTime) AS HourOfDay,
      DAYOFWEEK(LogEntryTime) AS DayOfWeek,
      DeviceType.value as DeviceType,
      DeviceMake,
      DeviceModel,
      RequestLanguages,
      MatchedLanguageCode,
      Browser.value as Browser,
      RenderingContext.value as RenderingContext,
      InternetConnectionType.value as InternetConnectionType,
      OperatingSystemFamily.value as OperatingSystemFamily,
      OperatingSystem.value as OperatingSystem,
      ContextualCategories,
      Country,
      Region,
      Metro,
      City,
      Zip,
      ReferrerUrl,
      BidRequestId,
      Latitude,
      Longitude,
      sin_hour_week,
      cos_hour_week,
      sin_minute_hour,
      cos_minute_hour,
      sin_minute_day,
      cos_minute_day
    FROM dataSource
    WHERE IsImp = true

# aggregation levels configuration
aggLevels:
  - level: AdvertiserId
    saltSize: 100
    initAggGrains: [hour]
    initWritePartitions: 10
    enableFeatureKeyCount: true
  - level: CampaignId 
    saltSize: 100
    initAggGrains: [ hour ]
    initWritePartitions: 10
    enableFeatureKeyCount: true
  - level: TDID
    saltSize: -1
    initAggGrains: [ hour, day ]
    initWritePartitions: 600
    rollupWritePartitions: 20000
    enableFeatureKeyCount: true

initAggConfig:
  outputRootPath: /Users/sven.zhang/Documents/local_test
  outputPrefix: /source=impressions/index={indexPartition}/job={grain}InitialAggJob
  dataIntegrity: AT_LEAST_ONE

rollupAggConfig:
  outputRootPath: "s3a://thetradedesk-mlplatform-us-east-1"
  outputPrefix: /features/feature_store/{ttdEnv}/profiles/source=impressions/index={indexPartition}/job=RollupAggJob/v=1/date={dateStr}/
  windowGrain: day

aggregations:
  - field: Site
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 500002
  - field: HourOfDay
    dataType: int
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 25
  - field: DayOfWeek
    dataType: int
    aggWindows: [ 7 ]
    aggFunc: [ Top7 ]
    cardinality: 8
  - field: DeviceType
    dataType: int
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top9 ]
    cardinality: 10
  - field: DeviceMake
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 6002
  - field: DeviceModel
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 40002
  - field: RequestLanguages
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 5002
  - field: MatchedLanguageCode
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 352
  - field: Browser
    dataType: int
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 25
  - field: RenderingContext
    dataType: int
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top6 ]
    cardinality: 7
  - field: InternetConnectionType
    dataType: int
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top10 ]
    cardinality: 11
  - field: OperatingSystemFamily
    dataType: int
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top7 ]
    cardinality: 8
  - field: OperatingSystem
    dataType: int
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 72
  - field: ContextualCategories
    dataType: array_long
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 500002
  - field: Country
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 252
  - field: Region
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 4002
  - field: Metro
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 202
  - field: City
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 150002
  - field: Zip
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 90002
  - field: ReferrerUrl
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Top15 ]
    cardinality: 500002
  - field: BidRequestId
    dataType: string
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Count ]
  - field: Latitude
    dataType: double
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Desc ]
  - field: Longitude
    dataType: double
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Desc ]
  - field: sin_hour_week
    dataType: double
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Desc ]
  - field: cos_hour_week
    dataType: double
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Desc ]
  - field: sin_minute_hour
    dataType: double
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Desc ]
  - field: cos_minute_hour
    dataType: double
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Desc ]
  - field: sin_minute_day
    dataType: double
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Desc ]
  - field: cos_minute_day
    dataType: double
    aggWindows: [ 1, 3, 7 ]
    aggFunc: [ Desc ]